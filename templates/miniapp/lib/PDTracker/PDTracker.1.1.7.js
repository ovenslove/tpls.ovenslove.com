var ArrayProto=Array.prototype,FuncProto=Function.prototype,ObjProto=Object.prototype,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeForEach=ArrayProto.forEach,nativeIndexOf=ArrayProto.indexOf,nativeIsArray=Array.isArray,breaker={};var _={};if(!Array.indexOf){Array.prototype.indexOf=function(el){for(var i=0,n=this.length;i<n;i++){if(this[i]===el){return i}}return-1}}_.checkTime=function(timeString){var date=timeString+"";var reg=/^(\d{4})-(\d{2})-(\d{2})$/;if(date){if(!reg.test(date)){return false}else{return true}}else{return false}};_.each=function(obj,iterator,context){if(obj===null||obj===undefined){return}if(nativeForEach&&obj.forEach===nativeForEach){obj.forEach(iterator,context)}else{if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(i in obj&&iterator.call(context,obj[i],i,obj)===breaker){return}}}else{for(var key in obj){if(hasOwnProperty.call(obj,key)){if(iterator.call(context,obj[key],key,obj)===breaker){return}}}}}};_.extend=function(obj){_.each(slice.call(arguments,1),(function(source){for(var prop in source){if(source[prop]!==void 0){obj[prop]=source[prop]}}}));return obj};_.isArray=nativeIsArray||function(obj){return Object.prototype.toString.apply(obj)==="[object Array]"};_.isObject=function(obj){return obj===Object(obj)&&!_.isArray(obj)};_.isUndefined=function(obj){return obj===void 0};_.truncate=function(obj,length){var ret;if(typeof obj==="string"){ret=obj.slice(0,length)}else{if(_.isArray(obj)){ret=[];_.each(obj,(function(val){ret.push(_.truncate(val,length))}))}else{if(_.isObject(obj)){ret={};_.each(obj,(function(val,key){ret[key]=_.truncate(val,length)}))}else{ret=obj}}}return ret};_.base64Encode=function(data){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o1,o2,o3,h1,h2,h3,h4,bits,i=0,ac=0,enc="",tmp_arr=[];if(!data){return data}data=_.utf8Encode(data);do{o1=data.charCodeAt(i++);o2=data.charCodeAt(i++);o3=data.charCodeAt(i++);bits=o1<<16|o2<<8|o3;h1=bits>>18&63;h2=bits>>12&63;h3=bits>>6&63;h4=bits&63;tmp_arr[ac++]=b64.charAt(h1)+b64.charAt(h2)+b64.charAt(h3)+b64.charAt(h4)}while(i<data.length);enc=tmp_arr.join("");switch(data.length%3){case 1:enc=enc.slice(0,-2)+"==";break;case 2:enc=enc.slice(0,-1)+"=";break}return enc};_.utf8Encode=function(string){string=(string+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");var utftext="",start,end;var stringl=0,n;start=end=0;stringl=string.length;for(n=0;n<stringl;n++){var c1=string.charCodeAt(n);var enc=null;if(c1<128){end++}else{if(c1>127&&c1<2048){enc=String.fromCharCode(c1>>6|192,c1&63|128)}else{enc=String.fromCharCode(c1>>12|224,c1>>6&63|128,c1&63|128)}}if(enc!==null){if(end>start){utftext+=string.substring(start,end)}utftext+=enc;start=end=n+1}}if(end>start){utftext+=string.substring(start,string.length)}return utftext};_.sha1=function(str){var hexcase=0;var b64pad="";var chrsz=8;function hex_sha1(s){return binb2hex(core_sha1(str2binb(s),s.length*chrsz))}function b64_sha1(s){return binb2b64(core_sha1(str2binb(s),s.length*chrsz))}function str_sha1(s){return binb2str(core_sha1(str2binb(s),s.length*chrsz))}function hex_hmac_sha1(key,data){return binb2hex(core_hmac_sha1(key,data))}function b64_hmac_sha1(key,data){return binb2b64(core_hmac_sha1(key,data))}function str_hmac_sha1(key,data){return binb2str(core_hmac_sha1(key,data))}function sha1_vm_test(){return hex_sha1("abc")=="a9993e364706816aba3e25717850c26c9cd0d89d"}function core_sha1(x,len){x[len>>5]|=128<<24-len%32;x[(len+64>>9<<4)+15]=len;var w=Array(80);var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;var e=-1009589776;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;var olde=e;for(var j=0;j<80;j++){if(j<16){w[j]=x[i+j]}else{w[j]=rol(w[j-3]^w[j-8]^w[j-14]^w[j-16],1)}var t=safe_add(safe_add(rol(a,5),sha1_ft(j,b,c,d)),safe_add(safe_add(e,w[j]),sha1_kt(j)));e=d;d=c;c=rol(b,30);b=a;a=t}a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);e=safe_add(e,olde)}return Array(a,b,c,d,e)}function sha1_ft(t,b,c,d){if(t<20){return b&c|~b&d}if(t<40){return b^c^d}if(t<60){return b&c|b&d|c&d}return b^c^d}function sha1_kt(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}function core_hmac_sha1(key,data){var bkey=str2binb(key);if(bkey.length>16){bkey=core_sha1(bkey,key.length*chrsz)}var ipad=Array(16),opad=Array(16);for(var i=0;i<16;i++){ipad[i]=bkey[i]^909522486;opad[i]=bkey[i]^1549556828}var hash=core_sha1(ipad.concat(str2binb(data)),512+data.length*chrsz);return core_sha1(opad.concat(hash),512+160)}function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}function rol(num,cnt){return num<<cnt|num>>>32-cnt}function str2binb(str){var bin=Array();var mask=(1<<chrsz)-1;for(var i=0;i<str.length*chrsz;i+=chrsz){bin[i>>5]|=(str.charCodeAt(i/chrsz)&mask)<<24-i%32}return bin}function binb2str(bin){var str="";var mask=(1<<chrsz)-1;for(var i=0;i<bin.length*32;i+=chrsz){str+=String.fromCharCode(bin[i>>5]>>>24-i%32&mask)}return str}function binb2hex(binarray){var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var str="";for(var i=0;i<binarray.length*4;i++){str+=hex_tab.charAt(binarray[i>>2]>>(3-i%4)*8+4&15)+hex_tab.charAt(binarray[i>>2]>>(3-i%4)*8&15)}return str}function binb2b64(binarray){var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var str="";for(var i=0;i<binarray.length*4;i+=3){var triplet=(binarray[i>>2]>>8*(3-i%4)&255)<<16|(binarray[i+1>>2]>>8*(3-(i+1)%4)&255)<<8|binarray[i+2>>2]>>8*(3-(i+2)%4)&255;for(var j=0;j<4;j++){if(i*8+j*6>binarray.length*32){str+=b64pad}else{str+=tab.charAt(triplet>>6*(3-j)&63)}}}return str}return hex_sha1(str)};_.UUID=function(){var callback=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)}))};return callback}();_.HTTPBuildQuery=function(formdata,arg_separator){var use_val,use_key,tmp_arr=[];if(_.isUndefined(arg_separator)){arg_separator="&"}_.each(formdata,(function(val,key){use_val=encodeURIComponent(val.toString());use_key=encodeURIComponent(key);tmp_arr[tmp_arr.length]=use_key+"="+use_val}));return tmp_arr.join(arg_separator)};_.HTTPParseUrl=function(url=""){var urls=url.split("?")||[];var params=urls[1]&&urls[1].split("&")||[];var obj={};for(var i=0;i<params.length;i++){var param=params[i].split("=");obj[param[0]]=param[1]}return obj};_.isJSONString=function(str){try{JSON.parse(str)}catch(e){return false}return true};_.localStorage={SDKAPI:{nameSpace:{},getStorageSync:function(){},setStorageSync:function(){}},setStorage:function(){},getStorage:function(){return this.SDKAPI.getStorageSync(PDTracker.config.localStorageCache)||""},_state:{},toState:function(t){var e=null;_.isJSONString(t)?(e=JSON.parse(t),e.deviceUdid?this._state=e:this.set("deviceUdid",_.UUID())):this.set("deviceUdid",_.UUID())},set:function(t,e){this._state=this._state||{};this._state[t]=e;return this.save()},get:function(t){return this._state[t]||""},save:function(){var saveComplete={isOk:true,errorMsg:""};try{var str=JSON.stringify(this._state);this.SDKAPI.setStorageSync(PDTracker.config.localStorageCache,str);if(str!==this.getStorage()){saveComplete.isOk=false;saveComplete.errorMsg="保存后，重新获取不一致"}}catch(error){saveComplete.isOk=false;saveComplete.errorMsg=error}return saveComplete},init:function(SDKAPI){if(!SDKAPI){return}this.SDKAPI=SDKAPI;var t=this.getStorage();t?this.toState(t):this.set("deviceUdid",_.UUID())}};_.console=function(){if("object"==typeof console&&console.log){try{return console.log.apply(console,arguments)}catch(t){console.log(arguments[0])}}};_.info={SDKAPI:{nameSpace:{},getSystemInfo:function(){},getNetworkType:function(){}},callback:function(){},properties:{},getSystem:function(){var self=this;var properties=self.properties;function getNetWork(){self.SDKAPI.getNetworkType({success:function(res){properties.networkType=res.networkType},complete:other})}function other(){self.SDKAPI.getSystemInfo({success:function(res){properties.deviceModel=res.model;properties.screenWidth=Number(res.windowWidth);properties.screenHeight=Number(res.windowHeight);properties.deviceOs=res.system.split(" ")[0];properties.deviceOsVersion=res.system.split(" ")[1],properties.devicePlatform=res.platform;properties.appPlatformVersion=res.version;properties.appPlatform=res.AppPlatform||"wx";properties.localeLanguage=res.language},complete:self.setStatusComplete.bind(self)})}getNetWork()},setStatusComplete:function(){_.localStorage.set("deviceProperties",this.properties);this.callback(this.properties)},init:function(SDKAPI){this.SDKAPI=SDKAPI}};var lLIBVERSION="1.0.1";var SDKTYPE="MiniProgram";function on(obj,event,callFn){if(obj[event]){var fn=obj[event];obj[event]=function(obj){callFn.call(this,obj,event);if(event==="onShareAppMessage"){return fn.call(this,obj)}else{fn.call(this,obj)}}}else{obj[event]=function(obj){callFn.call(this,obj,event)}}}var DATATYPE="e";var DEFAULTEVENTID={pd_session_start:{dataType:"ie"},pd_session_close:{dataType:"ie"},pd_u_login:{dataType:"ie"},pd_u_logout:{dataType:"ie"},pd_u_signup:{dataType:"ie"},pd_user_profile:{dataType:"ie"},pd_screen:{dataType:"pv"},pd_activate:{dataType:"ie"},pd_send_error:{dataType:"ie"},pd_share:{dataType:"ie"},pd_ad_click:{dataType:"ie"},pd_abtest:{dataType:"ie"},pd_onLaunch:{dataType:"ie"},pd_onShow:{dataType:"ie"}};var PDTracker={config:{miniType:"wx",apiType:"POST",apiHost:"https://stat.perfectdiary.com",debugHost:"https://dev-stat.perfectdiary.com",apiPath:"/v1/eventtracking/public/eventtracking_ecosystem",appKey:"",userId:"",sessionStartTime:"",persistedTime:"",lastEvent:{eventId:"",time:""},systemInfo:{},deviceUdid:"",debug:false,maxStringLength:255,trackLinksTimeout:300,costTime:{},appVersion:"",sendConfig:{start:false,fn:function(params){}},shareAll:false,share:true,allowAmendSharePath:true,superProperties:{},localStorageCache:"PDTracker_wechat",userProfile:{}},SDKAPI:{nameSpace:{},request:function(){},setStorageSync:function(){},getStorageSync:function(){},getSystemInfo:function(){},getNetworkType:function(){},showToast:function(){},connectSocket:function(){}},getSystemInfoComplete:false,queue:[],disabledEvents:[],curPageObj:null,shareDepth:"notFromShare",firstShareUid:"notFromShare",lastShareUid:"notFromShare",shareUrlPath:"notFromShare",setSDKAPI(config){let miniType=config.miniType||"wx";if(miniType==="wx"){this.SDKAPI.nameSpace=wx;this.SDKAPI.request=wx.request;this.SDKAPI.setStorageSync=wx.setStorageSync;this.SDKAPI.getStorageSync=wx.getStorageSync;this.SDKAPI.getSystemInfo=wx.getSystemInfo;this.SDKAPI.getNetworkType=wx.getNetworkType;this.SDKAPI.showToast=wx.showToast;this.SDKAPI.connectSocket=wx.connectSocket}},set(){var self=this;var count=0;var saveLocal=function(){var saveComplete=_.localStorage.set("config",JSON.stringify(self["config"]));var errorMsg=saveComplete.errorMsg;if(!saveComplete.isOk){if(2>count){count++;saveLocal()}else{if(typeof errorMsg!=="object"){errorMsg={errorMsg:errorMsg}}self.daSendError(errorMsg)}}};saveLocal()},init(appKey,config={}){this.setSDKAPI(config);_.localStorage.init(this.SDKAPI);_.info.init(this.SDKAPI);var localConfig=_.localStorage.get("config");var localUserProfile=_.localStorage.get("userProfile");if(_.isJSONString(localConfig)){localConfig=JSON.parse(localConfig);_.extend(this["config"],localConfig||{})}if(_.isObject(localUserProfile)){_.extend(this["config"],{userProfile:localUserProfile}||{})}_.extend(this["config"],config||{});this.getSystem();this.setConfig("appKey",appKey);if(this.config.debug){console.log(this.config)}},getConfig(propName){return this["config"][propName]},setConfig(propName,propVal){this["config"][propName]=propVal},setConfigOnce(propName,propVal){if(!this["config"][propName]){this.setConfig(propName,propVal);this.set()}},getDeviceUdid(){var localDeviceUdid=this.getConfig("deviceUdid");if(!localDeviceUdid){localDeviceUdid=_.localStorage.get("deviceUdid");this.setConfig("deviceUdid",localDeviceUdid);this.set()}return localDeviceUdid},getUserId(){return this.getConfig("userId")},getShareDepth(){if(typeof this.shareDepth==="number"){return this.shareDepth+1}return this.shareDepth},getFirstShareUid(){return this.firstShareUid||this.getUserId()||this.getDeviceUdid()},getLastShareUid(){return this.lastShareUid||""},getShareInfo(){var shareInfo={$firstShareUid:this.getFirstShareUid(),$lastShareUid:this.getUserId()||this.getDeviceUdid(),$shareUrlPath:this.getRoute(),$shareDepth:this.getShareDepth()};return shareInfo},setShareInfo(e,obj){var hubbleshare;var shareObj={$shareUrlPath:"notFromShare",$shareDepth:"notFromShare",$firstShareUid:"notFromShare",$lastShareUid:"notFromShare"};if(!(e&&_.isObject(e.query)&&e.query.hubbleshare)){_.extend(obj,shareObj);return}hubbleshare=decodeURIComponent(e.query.hubbleshare);if(!_.isJSONString(hubbleshare)){_.extend(obj,shareObj);return}hubbleshare=JSON.parse(hubbleshare);var $shareDepth=hubbleshare.$shareDepth;var $shareUrlPath=hubbleshare.$shareUrlPath;var $firstShareUid=hubbleshare.$firstShareUid;var $lastShareUid=hubbleshare.$lastShareUid;if(typeof $shareDepth==="number"){this.shareDepth=$shareDepth;obj.$shareDepth=$shareDepth}if(typeof $shareUrlPath==="string"){this.shareUrlPath=$shareUrlPath;obj.$shareUrlPath=$shareUrlPath}if(typeof $firstShareUid==="string"){this.firstShareUid=$firstShareUid;obj.$firstShareUid=$firstShareUid}if(typeof $lastShareUid==="string"){this.lastShareUid=$lastShareUid;obj.$lastShareUid=$lastShareUid}},getSystem(){var self=this;_.info.callback=function(systemInfo){self.getSystemInfoComplete=true;self.setConfig("systemInfo",systemInfo);self.set();if(self.queue.length>0){_.each(self.queue,(function(t){self.send.apply(self,Array.prototype.slice.call(t))}));self.queue=[]}};_.info.getSystem()},setRoute(route){this["config"]["route"]=route},getRoute(){return this["config"]["route"]},setUrl(route){var pageParameter=this.getPageParameter();route=route?route:this.getRoute();if(pageParameter){this["config"]["url"]=route+pageParameter}else{this["config"]["url"]=route}},getUrl(route){return this["config"]["url"]},setReferrer(referrer){referrer=typeof referrer!=="undefined"?referrer:this.getUrl();this.setOldReferrer(this["config"]["referrer"]);this["config"]["referrer"]=referrer},setOldReferrer(referrer){if(this["config"]["oldReferrer"]!==referrer){this["config"]["oldReferrer"]=referrer}},setScene(scene){if("number"==typeof scene||"string"==typeof scene&&""!==scene){this["config"]["scene"]=String(scene)}},getScene(){return this["config"]["scene"]},repeatSetReferrer(){this["config"]["referrer"]=this["config"]["oldReferrer"]},getReferrer(){return this["config"]["referrer"]},getPageParameter(){var currentPages=getCurrentPages();var route=this.getRoute();var obj={};var str="";for(var i=0;i<currentPages.length;i+=1){if(currentPages[i].route===route){obj=currentPages[i].options;break}}for(var key in obj){if(obj.hasOwnProperty(key)){if(key!=="hubbleshare"){if(str===""){str="?"+key+"="+obj[key]}else{str+="&"+key+"="+obj[key]}}}}return str},sessionStart(){if(this.getConfig("sessionUuid")){this.sessionClose()}this.setConfig("sessionUuid",_.UUID());this.setConfig("sessionStartTime",(new Date).getTime());this.track("pd_session_start")},sessionClose(){var sessionStartTime=this.getConfig("sessionStartTime");var lastEvent=this.getConfig("lastEvent")||{time:(new Date).getTime(),eventId:""};var sessionCloseTime=lastEvent.time;var sessionTotalLength=sessionCloseTime-sessionStartTime;this.track("pd_session_close",{sessionCloseTime:sessionCloseTime,sessionTotalLength:sessionTotalLength});this.setConfig("sessionUuid","")},daActivate(){var localDeviceUdid=this.getConfig("deviceUdid");if(!localDeviceUdid){localDeviceUdid=_.localStorage.get("deviceUdid");this.setConfig("deviceUdid",localDeviceUdid);this.track("pd_activate");this.set()}},daAdClick(){this.track("pd_ad_click")},daSendError(error){if(!error){this.track("pd_send_error",error)}},setEventTimer(eventName,timestamp){var timers=this.getConfig("costTime")||{};timers[eventName]=timestamp;this.setConfig("costTime",timers)},removeEventTimer(eventName){var timers=this.getConfig("costTime")||{};var timestamp=timers[eventName];if(!_.isUndefined(timestamp)){delete timers[eventName];this.setConfig("costTime",timers)}return timestamp},register_attributes(properties){if(_.isObject(properties)){let superProperties=this.getConfig("superProperties")||{};superProperties=_.extend({},superProperties,properties);this.setConfig("superProperties",superProperties);this.set()}},register_attributes_once(properties){if(_.isObject(properties)){let superProperties=this.getConfig("superProperties")||{};superProperties=_.extend({},properties,superProperties);this.setConfig("superProperties",superProperties);this.set()}},current_attributes(callbackFn){if(typeof callbackFn==="function"){callbackFn(this.getConfig("superProperties")||{})}},unregister_attributes(propertyName){if(typeof propertyName==="string"){let superProperties=this.getConfig("superProperties")||{};delete superProperties[propertyName];this.setConfig({superProperties:superProperties});this.set()}},clear_attributes(){this.setConfig("superProperties",{});this.set()},time_event(eventName){if(_.isUndefined(eventName)){_.console("必须传入事件名称");return}this.setEventTimer(eventName,(new Date).getTime())},track_pageview(properties){this.track("pd_screen",properties||{})},track_share(properties,channel){if(!this.config.allowAmendSharePath){properties=_.extend({},properties,{$firstShareUid:"notFromShare",$lastShareUid:"notFromShare",$shareDepth:"notFromShare",$shareUrlPath:"notFromShare"})}if(channel){properties.$channel=channel}else{delete properties.$channel}this.track("pd_share",properties)},track_onLaunch(properties){if(!this.config.allowAmendSharePath){properties=_.extend({},properties,{$firstShareUid:"notFromShare",$lastShareUid:"notFromShare",$shareDepth:"notFromShare",$shareUrlPath:"notFromShare"})}this.track("pd_onLaunch",properties)},track_onShow(properties){if(!this.config.allowAmendSharePath){properties=_.extend({},properties,{$firstShareUid:"notFromShare",$lastShareUid:"notFromShare",$shareDepth:"notFromShare",$shareUrlPath:"notFromShare"})}this.track("pd_onShow",properties)},get_user_id(){return this.getUserId()},get_distinct_id(){return this.getDeviceUdid()},signup(userId){var oldUserId=this.getConfig("userId");oldUserId=oldUserId==undefined?"":oldUserId;if(oldUserId==userId){return}this.setConfig("userId",userId);this.set();this.track("pd_u_signup",{oldUserId:oldUserId,newUserId:userId})},login(userId){this.signup(userId);this.track("pd_u_login")},logout(callback){this.setConfig("userId","");this.set();var hasCalled=false;function trackCallback(){if(!hasCalled){hasCalled=true;if(typeof callback==="function"){callback()}}}setTimeout(trackCallback,this.getConfig("trackLinksTimeout"));var data=this.track("pd_u_logout",{},trackCallback);return data},send(data,callback){if(!this.getSystemInfoComplete)return this.queue.push(arguments),!1;var isDebug=false;var isUpload=false;if(this["debug"]){isDebug=this["debug"].has_in_debug();isUpload=this["debug"].has_upload()}var count=0;var apiHost=this.getConfig("debug")?this.getConfig("debugHost"):this.getConfig("apiHost");var url=apiHost+this.getConfig("apiPath");var systemInfo=this.getConfig("systemInfo");var apiType=this.getConfig("apiType")||"POST";var basicInfo={deviceOs:systemInfo.deviceOs,deviceOsVersion:systemInfo.deviceOsVersion,devicePlatform:systemInfo.devicePlatform,appPlatformVersion:systemInfo.appPlatformVersion,appPlatform:systemInfo.appPlatform,screenWidth:systemInfo.screenWidth,screenHeight:systemInfo.screenHeight,deviceModel:systemInfo.deviceModel,networkType:systemInfo.networkType,localeLanguage:systemInfo.localeLanguage,appVersion:this.getConfig("appVersion"),scene:this.getScene(),miniType:this.getConfig("miniType")};if(isUpload){basicInfo.isDebug="1"}_.extend(data.data,basicInfo);var truncatedData=_.truncate(data["data"],this.getConfig("maxStringLength"));if(isDebug){this["debug"].log(truncatedData)}if(isDebug&&!isUpload){return}var jsonData=JSON.stringify(truncatedData);var encodedData=_.base64Encode(jsonData);var appkeyData=_.sha1(this.getConfig("appKey"));if(this.getConfig("debug")){_.console(truncatedData)}data["data"]=encodedData;data["time"]=(new Date).getTime().toString();data["appKey"]=appkeyData;if(apiType==="GET"){url+="?"+_.HTTPBuildQuery(data);data={}}var self=this;var sendData=function(){self.SDKAPI.request({url:url,method:apiType,data:data,success:function(res){if(typeof callback==="function"){callback(res,data)}},fail:function(){_.console("发送错误，重新发送");if(2>count){count++;sendData()}}})};if(this.getConfig("sendConfig").start){if(typeof this.getConfig("sendConfig").fn==="function"){var successFn=function(res){if(typeof callback==="function"){callback(res,truncatedData)}};var failFn=function(e){_.console("发送错误，重新发送")};this.getConfig("sendConfig").fn({url:url,method:"GET",success:successFn,fail:failFn,data:_.HTTPBuildQuery(data)})}}else{sendData()}},track(eventName,properties,callback){properties=properties||{};var dataType=DATATYPE;var otherProperties={};var userSetProperties=JSON.parse(JSON.stringify(properties));var startTimestamp=this.removeEventTimer(eventName);if(!_.isUndefined(startTimestamp)){otherProperties["costTime"]=(new Date).getTime()-startTimestamp}if(DEFAULTEVENTID[eventName]){dataType=DEFAULTEVENTID[eventName].dataType}var time=(new Date).getTime();if(eventName=="pd_session_close"){time=properties.sessionCloseTime;delete userSetProperties["sessionCloseTime"];delete userSetProperties["sessionTotalLength"]}if(eventName=="pd_session_start"){time=this.getConfig("sessionStartTime")}this.setConfigOnce("persistedTime",time);var systemInfo=this.getConfig("systemInfo");userSetProperties=_.extend({},this.getConfig("superProperties"),userSetProperties);var data={dataType:dataType,eventId:eventName,appKey:this.getConfig("appKey"),sessionUuid:this.getConfig("sessionUuid"),userId:this.getConfig("userId"),currentUrl:this.getUrl(),currentParams:_.HTTPParseUrl(this.getUrl()),sdkVersion:lLIBVERSION,sdkType:SDKTYPE,sessionTotalLength:properties.sessionTotalLength||0,time:time,persistedTime:this.getConfig("persistedTime"),deviceUdid:this.getDeviceUdid(),urlPath:this.getRoute(),referrer:this.getReferrer(),attributes:userSetProperties};if(!_.isUndefined(otherProperties["costTime"])){data["costTime"]=otherProperties["costTime"]}this.send({data:data},callback);if(["pd_session_close","pd_session_start"].indexOf(eventName)===-1){this.setConfig("lastEvent",{eventId:eventName,time:time})}},peopleSet(properties,to,callback){var data={dataType:"ie",appKey:this.getConfig("appKey"),sessionUuid:this.getConfig("sessionUuid"),deviceUdid:this.getDeviceUdid(),userId:this.getConfig("userId"),time:(new Date).getTime(),sdkType:SDKTYPE,eventId:"pd_user_profile",persistedTime:this.getConfig("persistedTime")};var $set={$userProfile:{$type:"profile_set"}};if(_.isObject(properties)){_.each(properties,(function(v,k){$set["$userProfile"][k]=v}),this);callback=to}else{$set["$userProfile"][prop]=to}data["attributes"]=$set;properties["userId"]=this.getConfig("userId");_.localStorage.set("userProfile",properties);this.send({data:data},callback)},people:{set(properties,to,callback){PDTracker.peopleSet(properties,to,callback)},set_realname(realname){PDTracker.peopleSet({$realName:realname})},set_country(country){PDTracker.peopleSet({$country:country})},set_province(province){PDTracker.peopleSet({$region:province})},set_city(city){PDTracker.peopleSet({$city:city})},set_gender(gender){if([0,1,2].indexOf(gender)>-1){PDTracker.peopleSet({$gender:gender})}},set_birthday(birthday){if(!_.checkTime(birthday))return;PDTracker.peopleSet({$birthday:birthday})},set_populationWithAccount(account,realname,birthday,gender){if(!account||!realname||!birthday||[0,1,2].indexOf(gender)===-1)return;if(!_.checkTime(birthday))return;PDTracker.peopleSet({$account:account,$realName:realname,$birthday:birthday,$gender:gender})},set_location(country,region,city){if(!country||!region||!city)return;PDTracker.peopleSet({$country:country,$region:region,$city:city})}}};function getSceneDebug(str){let token;let upload;let isDebug=false;let arr=str.split("&");if(!_.isUndefined(arr[0])&&!_.isUndefined(arr[1])){if(arr[0].length===6&&!isNaN(arr[1])){isDebug=true;token=arr[0];upload=arr[1]}}return{token:token,upload:upload,isDebug:isDebug}}function appLaunch(e){this["PDTracker"]=PDTracker;const sceneStr=e.query.scene&&decodeURIComponent(e.query.scene)||"";const sceneDebugConf=getSceneDebug(sceneStr);PDTracker.setScene(e.scene);PDTracker.setReferrer("");PDTracker.setOldReferrer("");PDTracker.daActivate();var pros={};PDTracker.setShareInfo(e,pros);PDTracker.track_onLaunch(pros)}function appShow(e){PDTracker.setScene(e.scene);PDTracker.repeatSetReferrer();PDTracker.sessionStart();var pros={};PDTracker.setShareInfo(e,pros);PDTracker.track_onShow(pros);PDTracker.set()}function pageOnshow(e){var self=this;var route="string"==typeof self.__route__?self.__route__:"";PDTracker.curPageObj=this;PDTracker.setRoute(route);PDTracker.setUrl();var onPageShow=function(){if(PDTracker.config.onPageShow){PDTracker.config.onPageShow(PDTracker,route,self)}else{PDTracker.track_pageview()}};onPageShow()}function onHide(){PDTracker.setReferrer();PDTracker.set()}function onUnload(){PDTracker.setReferrer();PDTracker.set()}function onShareAppMessage(e){if(PDTracker){PDTracker.track_share({},e&&e.channel)}}var p=App;var v=Page;App=function(obj){on(obj,"onLaunch",appLaunch);on(obj,"onShow",appShow);on(obj,"onHide",(function(){}));p(obj)};Page=function(obj){on(obj,"onLoad",(function(){}));on(obj,"onUnload",onUnload);on(obj,"onShow",pageOnshow);on(obj,"onHide",onHide);if(PDTracker.config.shareAll&&!PDTracker.config.allowAmendSharePath&&!PDTracker.config.share){on(obj,"onShareAppMessage",onShareAppMessage)}if(typeof obj.onShareAppMessage==="function"){var old=obj.onShareAppMessage;obj.onShareAppMessage=function(e){var isFirstShareFn=function(sharePath){var isFirst=true;if(PDTracker.firstShareUid!=="notFromShare"&&PDTracker.lastShareUid!=="notFromShare"&&PDTracker.shareUrlPath!=="notFromShare"&&PDTracker.shareDepth!=="notFromShare"){isFirst=false}if(sharePath){if(sharePath!=PDTracker.shareUrlPath){isFirst=true}}return isFirst};var shareInfo=old.apply(this,arguments);if(PDTracker.config.allowAmendSharePath){var localshareInfo=PDTracker.getShareInfo();if(typeof shareInfo.path==="string"&&shareInfo.path.indexOf("/")!==-1){try{var path=shareInfo.path.split("?")[0];localshareInfo.$shareUrlPath=path}catch(error){}}var isFirstShare=isFirstShareFn(localshareInfo.$shareUrlPath);if(isFirstShare){localshareInfo.$firstShareUid=PDTracker.getUserId()||PDTracker.getDeviceUdid();localshareInfo.$lastShareUid=PDTracker.getUserId()||PDTracker.getDeviceUdid();localshareInfo.$shareDepth=0}var daShareInfo={$shareUrlPath:localshareInfo.$shareUrlPath,$firstShareUid:localshareInfo.$firstShareUid,$lastShareUid:isFirstShare?"notFromShare":PDTracker.getLastShareUid(),$shareDepth:localshareInfo.$shareDepth};PDTracker.track_share(daShareInfo,e&&e.channel);if(typeof shareInfo.path==="string"&&shareInfo.path.indexOf("/")!==-1){if(shareInfo.path.indexOf("?")===-1){shareInfo.path=shareInfo.path+"?"}else if(shareInfo.path.slice(-1)!=="&"){shareInfo.path=shareInfo.path+"&"}shareInfo.path=shareInfo.path+"hubbleshare="+encodeURIComponent(JSON.stringify(localshareInfo))}}else if(PDTracker.config.share){PDTracker.track_share({},e&&e.channel)}console.log(shareInfo.path);return shareInfo}}v(obj)};export default PDTracker;